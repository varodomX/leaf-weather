<!DOCTYPE html>
<html>
<head>
    <title>Map TMD Data</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }
        .leaflet-tooltip {
            font-size: 22px; /* Adjust font size */
            padding: 10px; /* Increase tooltip size */
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div id="map"></div>
    <script>
        var map = L.map("map").setView([13.7563, 100.5018], 6);

        var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
        }).addTo(map);

        var defaultIcon = L.icon({
            iconUrl: "icon/sunny.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
        });

        var rainIcon = L.icon({
            iconUrl: "icon/rainny.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
        });

        var defaultLayerGroup = L.layerGroup();
        var rainLayerGroup = L.layerGroup().addTo(map);

        async function fetchDataAndDisplayMarkers() {
            try {
                const response = await fetch("http://localhost:3002/api/weather");
                const data = await response.json();

                function getColor(temp) {
                    const intensity = (temp - minTemp) / (maxTemp - minTemp);
                    if (intensity < 0.2) return "blue";
                    if (intensity < 0.4) return "cyan";
                    if (intensity < 0.6) return "lime";
                    if (intensity < 0.8) return "yellow";
                    return "red";
                }

                data.Stations.Station.forEach((station) => {
                    const lat = parseFloat(station.Latitude);
                    const lon = parseFloat(station.Longitude);
                    const stationName = station.StationNameThai;
                    const pressure = parseFloat(station.Observation.MeanSeaLevelPressure);
                    const temp = parseFloat(station.Observation.AirTemperature);
                    const humidity = parseFloat(station.Observation.RelativeHumidity);
                    const rainfall = parseFloat(station.Observation.Rainfall);
                    const rainfall24 = parseFloat(station.Observation.Rainfall24Hr);
                    const visibility = parseFloat(station.Observation.LandVisibility);
                    const wind = parseFloat(station.Observation.WindSpeed);

                    const icon = rainfall > 1 ? rainIcon : defaultIcon;

                    const marker = L.marker([lat, lon], { icon: icon })
                        .bindTooltip(
                            `สถานี: ${stationName}<br>
                            อุณหภูมิ: ${temp}°C<br>
                            ความกด: ${pressure}hPa<br>
                            ความชื้น: ${humidity}%<br>
                            ฝน: ${rainfall} มม.<br>
                            ลม: ${wind} นอต<br>
                            ทัศนวิสัย: ${visibility} กม.<br>
                            ฝน24ชม: ${rainfall24} มม.`
                        );

                    if (rainfall > 1) {
                        rainLayerGroup.addLayer(marker);
                    } else {
                        defaultLayerGroup.addLayer(marker);
                    }
                });

                defaultLayerGroup.addTo(map);
                rainLayerGroup.addTo(map);

                var baseLayers = {
                    "OpenStreetMap": osm
                };

                var overlays = {
                    "Default Markers": defaultLayerGroup,
                    "Rain Markers": rainLayerGroup
                };

                L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        async function addRainViewerLayer() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                const lastUpdated = data.radar.past[data.radar.past.length - 1].time;

                var rainViewerLayer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${lastUpdated}/256/{z}/{x}/{y}/4/1_1.png`, {
                    opacity: 0.7,
                    attribution: 'RainViewer'
                });

                rainViewerLayer.addTo(map);

                var overlays = {
                    "เรดาร์": rainViewerLayer,
                    "ข้อมูลสถานี": defaultLayerGroup,
                    "สถานีมีฝน": rainLayerGroup
                };

                L.control.layers(null, overlays, {collapsed: false}).addTo(map);

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }


        addRainViewerLayer();
        fetchDataAndDisplayMarkers();
    </script>
</body>
</html>
